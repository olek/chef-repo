#!/bin/bash

mode=unknown
case "$1" in
  true|thaw|resume)
    mode=battery
  ;;
  false)
    mode=ac
  ;;
  *)
    # assume battery
    mode=battery
  ;;
esac

sound=car_door
lpmp=min_power
cpu_governor=conservative
if [ "$mode" == "ac" ]; then
  sound=whiff
  lpmp=max_performance
  cpu_governor=ondemand
fi

prefix="[trifty]"

function set_param {
  for i in $1; do
    old="`cat $i`"
    if [ "$old" != "$2" ]
    then
      echo "$prefix changing $old to $2 for $i"
      echo $2 > $i
    # else
    #   echo "$prefix leaving $old for $i"
    fi
  done
}

set_param '/sys/class/scsi_host/host*/link_power_management_policy' $lpmp

# ethtool -s eth0 wol d

CURRENT_USER=$(who | grep 'tty7\| :0' | sed 's/\([a-z]*\).*/\1/')
# sudo -H -u $CURRENT_USER /bin/bash -c 'export DISPLAY=:0.0 && /usr/local/bin/adjust-scroll'
# sudo -H -u $CURRENT_USER /bin/bash -c 'export DISPLAY=:0.0 && xmodmap -e "keycode 156 = Break"'


# set_param /sys/devices/platform/i8042/serio1/serio2/sensitivity 255
# set_param /sys/devices/platform/i8042/serio1/serio2/speed 180
# set_param /sys/devices/platform/i8042/serio1/serio2/inertia 2

# if [ "$mode" == "battery" ]; then
#  ifconfig eth0 down
#  ethtool -s eth0 autoneg off speed 10
#  killall indicator-multiload # consumes about 200mw
# else
#  ifconfig eth0 up
#  ethtool -s eth0 autoneg on
#  sudo -H -u $CURRENT_USER /bin/bash -c 'export DISPLAY=:0.0 && /usr/bin/indicator-multiload &'
# fi

iwconfig wlan0 power on

set_param '/sys/devices/system/cpu/cpu*/cpufreq/scaling_governor' $cpu_governor
set_param /proc/sys/kernel/nmi_watchdog 0
set_param '/sys/bus/pci/devices/*/power/control' auto

set_param /sys/module/snd_hda_intel/parameters/power_save_controller Y
set_param /sys/module/snd_hda_intel/parameters/power_save 1
sleep 1; aplay --quiet /usr/lib/python2.7/dist-packages/pygame/examples/data/${sound}.wav & # 14.04
#echo -n | aplay

#extra
modprobe coretemp

# not conclusive
set_param /proc/sys/vm/laptop_mode 5

# Reduce disk activity by waiting up to 10 minutes before doing writes
#set_param /proc/sys/vm/dirty_ratio 90
#set_param /proc/sys/vm/dirty_background_ratio 1
#set_param /proc/sys/vm/dirty_writeback_centisecs 60000

# next line causes external keyboard/mouse to disappear
# set_param '/sys/bus/usb/devices/*/power/level' auto
set_param '/sys/bus/usb/devices/*/power/autosuspend' 1

set_param /sys/block/sda/queue/scheduler deadline
set_param /sys/block/sda/queue/iosched/fifo_batch 1

# workaround for the problem of wifi not always coming back after resume on thinkpads
case "$1" in
  thaw|resume)
    nmcli nm sleep false
  ;;
esac

<<EOF
Notes:
All testing done with Samsung 470 SSD

Loaded into X, and cooled to 'no fan', system
  starts at 7.5w
  optimized by script to 6.2W
  with dpms off drops to 5.0w
  with fan on, system is usable at 6.8w

  overall gain - 1.3w
EOF
